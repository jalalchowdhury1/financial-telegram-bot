name: Daily Financial Report

on:
  schedule:
    # Run every day at 4:15 AM EST (9:15 UTC)
    - cron: '15 9 * * *'

  # Allow manual trigger for testing
  workflow_dispatch:

  # Allow triggering via Telegram bot or API
  repository_dispatch:
    types: [telegram-report]

jobs:
  generate-and-send-report:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Verify secrets are present
        run: |
          echo "Checking for required secrets..."
          if [ -z "${{ secrets.FRED_API_KEY }}" ]; then
            echo "ERROR: FRED_API_KEY secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.TELEGRAM_TOKEN }}" ]; then
            echo "ERROR: TELEGRAM_TOKEN secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.TELEGRAM_CHAT_ID }}" ]; then
            echo "ERROR: TELEGRAM_CHAT_ID secret is not set"
            exit 1
          fi
          echo "âœ“ All required secrets are present"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Generate and send financial charts
        env:
          FRED_API_KEY: ${{ secrets.FRED_API_KEY }}
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        run: |
          python main.py

      - name: Upload charts as artifacts (for debugging)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: financial-charts-${{ github.run_number }}
          path: |
            *.png
          retention-days: 7
