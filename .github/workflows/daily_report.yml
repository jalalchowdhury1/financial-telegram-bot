# yaml-language-server: $schema=https://json.schemastore.org/github-workflow
name: Daily Financial Report

on:
  workflow_dispatch:
    inputs:
      retry_count:
        description: 'Number of retry attempts so far'
        required: false
        default: '0'
  schedule:
    # Run every day at 4:15 AM EST (9:15 UTC)
    - cron: '15 9 * * *'

  # Allow triggering via Telegram bot or API
  repository_dispatch:
    types: [telegram-report]

jobs:
  generate-and-send-report:
    runs-on: ubuntu-latest
    permissions:
      actions: write  # Allow triggering workflow_dispatch on retry

    # Job-level env ensures every step sees these
    env:
      FRED_API_KEY: ${{ secrets.FRED_API_KEY }}
      ALPHA_VANTAGE_API_KEY: ${{ secrets.ALPHA_VANTAGE_API_KEY }}
      TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Verify secrets are present
        run: |
          echo "Checking for required secrets..."
          if [ -z "$FRED_API_KEY" ]; then
            echo "ERROR: FRED_API_KEY secret is not set"
            exit 1
          fi
          if [ -z "$ALPHA_VANTAGE_API_KEY" ]; then
            echo "ERROR: ALPHA_VANTAGE_API_KEY secret is not set"
            exit 1
          fi
          if [ -z "$TELEGRAM_TOKEN" ]; then
            echo "ERROR: TELEGRAM_TOKEN secret is not set"
            exit 1
          fi
          if [ -z "$TELEGRAM_CHAT_ID" ]; then
            echo "ERROR: TELEGRAM_CHAT_ID secret is not set"
            exit 1
          fi
          echo "✓ All required secrets are present"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Generate and send financial charts
        id: report
        run: python main.py
        continue-on-error: true

      - name: Retry on failure
        if: steps.report.outcome == 'failure'
        env:
          GITHUB_TOKEN: ${{ github.token }}
          RETRY_COUNT: ${{ github.event.inputs.retry_count || '0' }}
          MAX_RETRIES: 3  # 3 retries × 10 min = 30 min max
        run: |
          CURRENT_RETRY=$((RETRY_COUNT))
          NEXT_RETRY=$((CURRENT_RETRY + 1))

          echo "Report generation failed on attempt $((CURRENT_RETRY + 1))"

          if [ $CURRENT_RETRY -lt $MAX_RETRIES ]; then
            echo "Scheduling retry $NEXT_RETRY in 10 minutes..."
            sleep 600  # 10 minutes = 600 seconds

            echo "Triggering retry attempt $NEXT_RETRY via GitHub API..."
            curl -X POST \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer $GITHUB_TOKEN" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              https://api.github.com/repos/${{ github.repository }}/actions/workflows/daily_report.yml/dispatches \
              -d "{\"ref\":\"${{ github.ref_name }}\",\"inputs\":{\"retry_count\":\"$NEXT_RETRY\"}}"

            echo "Retry scheduled successfully"
          else
            echo "Max retries ($MAX_RETRIES) reached. Giving up."
            exit 1
          fi

      - name: Mark as failed if report generation failed
        if: steps.report.outcome == 'failure'
        run: exit 1

      - name: Upload charts as artifacts (for debugging)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: financial-charts-${{ github.run_number }}
          path: |
            *.png
          retention-days: 7
